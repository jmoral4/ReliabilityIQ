@page "/run/{runId}/churn"
@model ReliabilityIQ.Web.Pages.Run.ChurnModel
@{
    ViewData["Title"] = "Churn";
}

@if (Model.Run is null)
{
    <div class="alert alert-warning" role="alert">Run not found.</div>
}
else
{
    <section class="mb-3">
        <h1 class="h3 mb-1">Churn and Staleness</h1>
        <div class="small text-body-secondary">
            <span class="font-monospace">@Model.Run.RunId</span>
            <span class="mx-2">|</span>
            <span class="font-monospace">@Model.Run.RepoRoot</span>
        </div>
    </section>

    <div class="row g-3 mb-3">
        <aside class="col-12 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-body-secondary">Filters</h2>
                    <div class="mb-3">
                        <label for="minChurnFilter" class="form-label">Minimum Churn Score</label>
                        <input id="minChurnFilter" type="number" min="0" step="0.1" value="0" class="form-control form-control-sm" />
                    </div>
                    <div class="mb-3">
                        <label for="maxStaleFilter" class="form-label">Maximum Stale Score</label>
                        <input id="maxStaleFilter" type="number" min="0" step="0.1" value="9999" class="form-control form-control-sm" />
                    </div>
                    <div class="mb-3">
                        <label for="pathPrefixFilter" class="form-label">Module / Directory Prefix</label>
                        <input id="pathPrefixFilter" type="text" class="form-control form-control-sm font-monospace" placeholder="src/" />
                    </div>
                    <button id="applyFilters" type="button" class="btn btn-sm btn-primary w-100">Apply Filters</button>
                </div>
            </div>
        </aside>

        <div class="col-12 col-lg-9">
            <div class="table-responsive">
                <table id="churnTable" class="table table-striped table-hover align-middle w-100">
                    <thead>
                    <tr>
                        <th>File Path</th>
                        <th>Churn</th>
                        <th>Stale</th>
                        <th>Commits (90d)</th>
                        <th>Authors (365d)</th>
                        <th>Ownership %</th>
                        <th>Last Commit</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="h6 text-uppercase text-body-secondary mb-3">Ownership Risk</h2>
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle mb-0" id="ownershipTable">
                    <thead>
                    <tr>
                        <th>File</th>
                        <th>Top Author</th>
                        <th>Top Author %</th>
                        <th>Authors</th>
                        <th>Last Commit</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts
{
    <script>
        function escapeHtml(value) {
            if (!value) return "";
            return String(value)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function scoreBar(value, maxValue, cssClass) {
            const score = Number(value || 0);
            const ratio = maxValue > 0 ? Math.max(0, Math.min(100, Math.round((score / maxValue) * 100))) : 0;
            return `<div class="small fw-semibold mb-1">${score.toFixed(2)}</div><div class="progress stacked-progress"><div class="progress-bar ${cssClass}" style="width:${ratio}%"></div></div>`;
        }

        async function loadOwnership(runId) {
            const response = await fetch(`/api/run/${encodeURIComponent(runId)}/churn/ownership`, { headers: { "Accept": "application/json" } });
            const tbody = document.querySelector("#ownershipTable tbody");
            if (!response.ok) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-body-secondary">Unable to load ownership data.</td></tr>';
                return;
            }

            const rows = await response.json();
            if (!Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-body-secondary">No ownership concentration risks found.</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(row => {
                const runIdEncoded = encodeURIComponent(runId);
                const fileIdEncoded = encodeURIComponent(row.fileId);
                const badge = row.isOrphaned
                    ? '<span class="badge text-bg-danger">Orphaned</span>'
                    : '<span class="badge text-bg-warning text-dark">Concentrated</span>';
                return `<tr>
                    <td class="font-monospace small"><a class="link-dark" href="/run/${runIdEncoded}/file/${fileIdEncoded}">${escapeHtml(row.filePath)}</a></td>
                    <td>${escapeHtml(row.topAuthor || "n/a")}</td>
                    <td>${(Number(row.topAuthorPct || 0) * 100).toFixed(1)}%</td>
                    <td>${Number(row.authors365d || 0)}</td>
                    <td>${escapeHtml(row.lastCommitAt || "n/a")}</td>
                    <td>${badge}</td>
                </tr>`;
            }).join("");
        }

        (async function () {
            const runId = "@Model.RunId";
            const table = new DataTable("#churnTable", {
                serverSide: true,
                processing: true,
                pageLength: 25,
                order: [[1, "desc"]],
                ajax: {
                    url: `/api/run/${encodeURIComponent(runId)}/churn`,
                    data: function (d) {
                        d.minChurnScore = document.getElementById("minChurnFilter").value;
                        d.maxStaleScore = document.getElementById("maxStaleFilter").value;
                        d.pathPrefix = document.getElementById("pathPrefixFilter").value;
                    }
                },
                columns: [
                    {
                        data: null,
                        name: "filePath",
                        className: "font-monospace small",
                        render: function (_, __, row) {
                            const runIdEncoded = encodeURIComponent(runId);
                            const fileIdEncoded = encodeURIComponent(row.fileId);
                            return `<a class="link-dark" href="/run/${runIdEncoded}/file/${fileIdEncoded}">${escapeHtml(row.filePath)}</a>`;
                        }
                    },
                    {
                        data: "churnScore",
                        name: "churnScore",
                        render: function (value) { return scoreBar(value, 15, "bg-danger"); }
                    },
                    {
                        data: "staleScore",
                        name: "staleScore",
                        render: function (value) { return scoreBar(value, 365, "bg-secondary"); }
                    },
                    { data: "commits90d", name: "commits90d" },
                    { data: "authors365d", name: "authors365d" },
                    {
                        data: "ownershipConcentration",
                        name: "ownershipConcentration",
                        render: function (value, _, row) {
                            const percent = `${(Number(value || 0) * 100).toFixed(1)}%`;
                            const badge = row.isOrphaned
                                ? '<span class="badge text-bg-danger ms-2">Orphaned</span>'
                                : Number(value || 0) > 0.8
                                    ? '<span class="badge text-bg-warning text-dark ms-2">High</span>'
                                    : '';
                            return `${percent}${badge}`;
                        }
                    },
                    {
                        data: "lastCommitAt",
                        name: "lastCommitAt",
                        render: function (value) { return escapeHtml(value || "n/a"); }
                    }
                ]
            });

            document.getElementById("applyFilters").addEventListener("click", function () {
                table.ajax.reload();
                loadOwnership(runId);
            });

            await loadOwnership(runId);
        })();
    </script>
}
