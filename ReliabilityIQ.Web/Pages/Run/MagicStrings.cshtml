@page "/run/{runId}/magic-strings"
@model ReliabilityIQ.Web.Pages.Run.MagicStringsModel
@{
    ViewData["Title"] = "Magic Strings";
}

@if (Model.Run is null)
{
    <div class="alert alert-warning" role="alert">Run not found.</div>
}
else
{
    <section class="mb-3">
        <h1 class="h3 mb-1">Magic Strings</h1>
        <div class="small text-body-secondary">
            <span class="font-monospace">@Model.Run.RunId</span>
            <span class="mx-2">|</span>
            <span class="font-monospace">@Model.Run.RepoRoot</span>
            <span class="mx-2">|</span>
            <a asp-page="/Run/Findings" asp-route-runId="@Model.RunId" class="link-secondary">Open in Findings</a>
        </div>
    </section>

    <div class="row g-3">
        <aside class="col-12 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-body-secondary">Filters</h2>

                    <div class="mb-3">
                        <label for="minScoreFilter" class="form-label">Minimum Score: <span id="minScoreValue">1.0</span></label>
                        <input id="minScoreFilter" type="range" min="0" max="10" step="0.1" value="1.0" class="form-range" />
                    </div>

                    <div class="mb-3">
                        <label for="minCountFilter" class="form-label">Minimum Occurrences</label>
                        <input id="minCountFilter" type="number" min="1" value="2" class="form-control form-control-sm" />
                    </div>

                    <div class="mb-3">
                        <label for="languageFilter" class="form-label">Language</label>
                        <select id="languageFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="pathPrefixFilter" class="form-label">Path Prefix</label>
                        <input id="pathPrefixFilter" type="text" class="form-control form-control-sm font-monospace" placeholder="src/" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Aggregation Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scopeFilter" id="scopeOverall" value="overall" checked />
                            <label class="form-check-label" for="scopeOverall">Overall</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scopeFilter" id="scopeModule" value="module" />
                            <label class="form-check-label" for="scopeModule">Per module</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="topNFilter" class="form-label">Top N</label>
                        <select id="topNFilter" class="form-select form-select-sm">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <button id="applyFilters" type="button" class="btn btn-sm btn-primary w-100">Apply Filters</button>
                </div>
            </div>
        </aside>

        <div class="col-12 col-xl-9">
            <div class="table-responsive mb-3">
                <table id="magicStringsTable" class="table table-striped table-hover align-middle w-100">
                    <thead>
                    <tr>
                        <th></th>
                        <th>Score</th>
                        <th>Literal</th>
                        <th>Count</th>
                        <th>Top Location</th>
                        <th>Language(s)</th>
                        <th>Rule</th>
                    </tr>
                    </thead>
                </table>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-body-secondary mb-3">Top Per Directory</h2>
                    <div id="moduleTree" class="accordion"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="occurrencesModal" tabindex="-1" aria-labelledby="occurrencesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="occurrencesModalLabel">All Occurrences</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="occurrencesMeta" class="small text-body-secondary mb-2"></div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                            <tr>
                                <th>File</th>
                                <th>Line</th>
                                <th>Column</th>
                                <th>Language</th>
                                <th>AST Context</th>
                                <th>Callsite</th>
                            </tr>
                            </thead>
                            <tbody id="occurrencesBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="occPrev" type="button" class="btn btn-sm btn-outline-secondary">Previous</button>
                    <span id="occPageLabel" class="small text-body-secondary"></span>
                    <button id="occNext" type="button" class="btn btn-sm btn-outline-secondary">Next</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts
{
    <script>
        function escapeHtml(value) {
            if (!value) return "";
            return String(value)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function truncate(value, length) {
            if (!value) return "";
            return value.length <= length ? value : `${value.slice(0, length - 1)}...`;
        }

        function scoreCell(score) {
            const normalized = Math.max(0, Math.min(10, Number(score || 0)));
            const width = Math.round((normalized / 10) * 100);
            return `<div class="small fw-semibold mb-1">${normalized.toFixed(3)}</div><div class="progress" role="progressbar" aria-valuenow="${width}" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar bg-success" style="width:${width}%"></div></div>`;
        }

        function topLocationCell(row) {
            const path = escapeHtml(row.topFilePath || "n/a");
            const line = Number(row.topLine || 0);
            return `<span class="font-monospace small">${path}:${line}</span>`;
        }

        function scopeValue() {
            return document.querySelector("input[name='scopeFilter']:checked")?.value || "overall";
        }

        function buildOccurrenceRows(occurrences, offset, pageSize) {
            return occurrences
                .slice(offset, offset + pageSize)
                .map(o => `<tr>
                    <td class="font-monospace small">${escapeHtml(o.file)}</td>
                    <td>${Number(o.line || 0)}</td>
                    <td>${Number(o.column || 0)}</td>
                    <td>${escapeHtml(o.language || "-")}</td>
                    <td><span class="font-monospace small">${escapeHtml(o.astParent || "-")}</span></td>
                    <td><span class="font-monospace small">${escapeHtml(o.callsite || "-")}</span></td>
                </tr>`)
                .join("");
        }

        async function loadFilterOptions(runId) {
            const response = await fetch(`/api/run/${encodeURIComponent(runId)}/magic-strings/filters`, { headers: { "Accept": "application/json" } });
            if (!response.ok) {
                return;
            }

            const payload = await response.json();
            const languageFilter = document.getElementById("languageFilter");
            for (const language of (payload.languages || [])) {
                const option = document.createElement("option");
                option.value = language;
                option.textContent = language;
                languageFilter.appendChild(option);
            }
        }

        async function loadModuleView(runId) {
            const query = new URLSearchParams({
                minScore: document.getElementById("minScoreFilter").value,
                minOccurrences: document.getElementById("minCountFilter").value,
                language: document.getElementById("languageFilter").value,
                pathPrefix: document.getElementById("pathPrefixFilter").value,
                topN: document.getElementById("topNFilter").value
            });

            const response = await fetch(`/api/run/${encodeURIComponent(runId)}/magic-strings/modules?${query.toString()}`, { headers: { "Accept": "application/json" } });
            const container = document.getElementById("moduleTree");
            if (!response.ok) {
                container.innerHTML = '<p class="text-body-secondary mb-0">Unable to load module aggregation.</p>';
                return;
            }

            const groups = await response.json();
            if (!Array.isArray(groups) || groups.length === 0) {
                container.innerHTML = '<p class="text-body-secondary mb-0">No module-level candidates for current filters.</p>';
                return;
            }

            container.innerHTML = groups.map((group, index) => {
                const headingId = `module-heading-${index}`;
                const collapseId = `module-collapse-${index}`;
                const rows = (group.candidates || []).map(candidate => `<tr>
                    <td class="font-monospace small">${escapeHtml(truncate(candidate.literal, 72))}</td>
                    <td>${Number(candidate.magicScore || 0).toFixed(3)}</td>
                    <td>${Number(candidate.occurrenceCount || 0)}</td>
                    <td class="font-monospace small">${escapeHtml(candidate.topFilePath || "n/a")}:${Number(candidate.topLine || 0)}</td>
                </tr>`).join("");
                return `<div class="accordion-item">
                    <h3 class="accordion-header" id="${headingId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                            <span class="font-monospace">${escapeHtml(group.module || ".")}</span>&nbsp;<span class="text-body-secondary">(${Number(group.totalCandidates || 0)} candidates)</span>
                        </button>
                    </h3>
                    <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headingId}" data-bs-parent="#moduleTree">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped mb-0">
                                    <thead><tr><th>Literal</th><th>Score</th><th>Count</th><th>Top Location</th></tr></thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join("");
        }

        (async function () {
        const runId = "@Model.RunId";
        const occurrencesModalElement = document.getElementById("occurrencesModal");
        const occurrencesModal = new bootstrap.Modal(occurrencesModalElement);
        const occurrencesState = { items: [], page: 0, pageSize: 20, literal: "" };
        const occurrencesByFinding = new Map();

        const table = new DataTable("#magicStringsTable", {
            serverSide: true,
            processing: true,
            pageLength: 25,
            ordering: false,
            ajax: {
                url: `/api/run/${encodeURIComponent(runId)}/magic-strings`,
                data: function (d) {
                    d.minScore = document.getElementById("minScoreFilter").value;
                    d.minOccurrences = document.getElementById("minCountFilter").value;
                    d.language = document.getElementById("languageFilter").value;
                    d.pathPrefix = document.getElementById("pathPrefixFilter").value;
                    d.scope = scopeValue();
                    d.topN = document.getElementById("topNFilter").value;
                }
            },
            columns: [
                {
                    data: null,
                    orderable: false,
                    className: "details-toggle",
                    defaultContent: '<button class="btn btn-sm btn-outline-secondary" type="button">+</button>'
                },
                {
                    data: "magicScore",
                    render: function (score) { return scoreCell(score); }
                },
                {
                    data: "literal",
                    className: "font-monospace small",
                    render: function (value) { return `<span title="${escapeHtml(value)}">${escapeHtml(truncate(value, 80))}</span>`; }
                },
                { data: "occurrenceCount" },
                {
                    data: null,
                    render: function (_, __, row) { return topLocationCell(row); }
                },
                {
                    data: "languages",
                    render: function (languages) {
                        const values = Array.isArray(languages) ? languages : [];
                        return values.length > 0 ? escapeHtml(values.join(", ")) : "-";
                    }
                },
                { data: "ruleId", className: "font-monospace small" }
            ]
        });

        function renderOccurrenceModal() {
            const offset = occurrencesState.page * occurrencesState.pageSize;
            const totalPages = Math.max(1, Math.ceil(occurrencesState.items.length / occurrencesState.pageSize));
            document.getElementById("occurrencesBody").innerHTML = buildOccurrenceRows(occurrencesState.items, offset, occurrencesState.pageSize);
            document.getElementById("occPageLabel").textContent = `Page ${occurrencesState.page + 1} of ${totalPages}`;
            document.getElementById("occurrencesMeta").textContent = `Literal: ${occurrencesState.literal} | ${occurrencesState.items.length} occurrences`;
            document.getElementById("occPrev").disabled = occurrencesState.page <= 0;
            document.getElementById("occNext").disabled = occurrencesState.page >= totalPages - 1;
        }

        function applyAll() {
            table.ajax.reload();
            loadModuleView(runId);
        }

        document.getElementById("minScoreFilter").addEventListener("input", function () {
            document.getElementById("minScoreValue").textContent = Number(this.value).toFixed(1);
        });

        document.getElementById("applyFilters").addEventListener("click", applyAll);

        document.getElementById("magicStringsTable").addEventListener("click", function (event) {
            const button = event.target.closest("button");
            if (!button) {
                return;
            }

            const rowElement = button.closest("tr");
            const row = table.row(rowElement);
            if (row.child.isShown()) {
                row.child.hide();
                button.textContent = "+";
                return;
            }

            const data = row.data();
            const occurrences = Array.isArray(data.occurrences) ? data.occurrences : [];
            const previewRows = buildOccurrenceRows(occurrences, 0, 8);
            occurrencesByFinding.set(Number(data.findingId || 0), occurrences);
            const details = `<div class="p-2">
                <div class="small text-body-secondary mb-2">${escapeHtml(data.contextSummary || "No context summary available.")}</div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-2">
                        <thead>
                            <tr><th>File</th><th>Line</th><th>Column</th><th>Language</th><th>AST Context</th><th>Callsite</th></tr>
                        </thead>
                        <tbody>${previewRows || '<tr><td colspan="6" class="text-body-secondary">No occurrences captured.</td></tr>'}</tbody>
                    </table>
                </div>
                <button class="btn btn-sm btn-outline-primary show-all-occurrences" type="button" data-finding-id="${Number(data.findingId || 0)}" data-literal="${escapeHtml(data.literal || "n/a")}">Show All Occurrences</button>
            </div>`;

            row.child(details).show();
            button.textContent = "-";
        });

        document.getElementById("magicStringsTable").addEventListener("click", function (event) {
            const showAllButton = event.target.closest("button.show-all-occurrences");
            if (!showAllButton) {
                return;
            }

            const findingId = Number(showAllButton.getAttribute("data-finding-id") || "0");
            occurrencesState.items = occurrencesByFinding.get(findingId) || [];
            occurrencesState.page = 0;
            occurrencesState.literal = showAllButton.getAttribute("data-literal") || "n/a";
            renderOccurrenceModal();
            occurrencesModal.show();
        });

        document.getElementById("occPrev").addEventListener("click", function () {
            if (occurrencesState.page > 0) {
                occurrencesState.page--;
                renderOccurrenceModal();
            }
        });

        document.getElementById("occNext").addEventListener("click", function () {
            const totalPages = Math.ceil(occurrencesState.items.length / occurrencesState.pageSize);
            if (occurrencesState.page < totalPages - 1) {
                occurrencesState.page++;
                renderOccurrenceModal();
            }
        });

        await loadFilterOptions(runId);
        await loadModuleView(runId);
        })();
    </script>
}
