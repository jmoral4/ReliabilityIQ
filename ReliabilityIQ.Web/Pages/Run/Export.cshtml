@page "/run/{runId}/export"
@model ReliabilityIQ.Web.Pages.Run.ExportModel
@{
    ViewData["Title"] = "Export";
}

@if (Model.Run is null)
{
    <div class="alert alert-warning" role="alert">Run not found.</div>
}
else
{
    <section class="mb-3">
        <h1 class="h3 mb-1">Export</h1>
        <div class="small text-body-secondary">
            <span class="font-monospace">@Model.Run.RunId</span>
            <span class="mx-2">|</span>
            <span>Download findings in CSV, JSON, SARIF, or HTML.</span>
        </div>
    </section>

    <div class="row g-3 mb-3">
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label" for="severity">Severity</label>
            <select id="severity" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="Error">Error</option>
                <option value="Warning">Warning</option>
                <option value="Info">Info</option>
            </select>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label" for="rule">Rule</label>
            <input id="rule" class="form-control form-control-sm font-monospace" placeholder="portability.hardcoded.dns" />
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label" for="rulePrefix">Rule Prefix</label>
            <input id="rulePrefix" class="form-control form-control-sm font-monospace" placeholder="deploy." />
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label" for="pathPrefix">Path Prefix</label>
            <input id="pathPrefix" class="form-control form-control-sm font-monospace" placeholder="src/" />
        </div>
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="includeSuppressed" />
        <label class="form-check-label" for="includeSuppressed">Include suppressed findings</label>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-primary" type="button" onclick="downloadExport('csv')">Export CSV</button>
        <button class="btn btn-outline-primary" type="button" onclick="downloadExport('json')">Export JSON</button>
        <button class="btn btn-outline-primary" type="button" onclick="downloadExport('sarif')">Export SARIF</button>
        <button class="btn btn-outline-primary" type="button" onclick="downloadExport('html')">Export HTML</button>
    </div>

    <a class="btn btn-link px-0" asp-page="/Run/Compare" asp-route-runId="@Model.RunId">Open Run Comparison</a>
}

@section Scripts
{
    <script>
        function downloadExport(format) {
            const runId = "@Model.RunId";
            const query = new URLSearchParams();

            const severity = document.getElementById("severity").value;
            const rule = document.getElementById("rule").value;
            const rulePrefix = document.getElementById("rulePrefix").value;
            const pathPrefix = document.getElementById("pathPrefix").value;
            const includeSuppressed = document.getElementById("includeSuppressed").checked;

            if (severity) query.set("severity", severity);
            if (rule) query.set("rule", rule);
            if (rulePrefix) query.set("rulePrefix", rulePrefix);
            if (pathPrefix) query.set("pathPrefix", pathPrefix);
            if (includeSuppressed) query.set("includeSuppressed", "true");

            const href = `/api/run/${encodeURIComponent(runId)}/export/${encodeURIComponent(format)}?${query.toString()}`;
            window.location.href = href;
        }
    </script>
}
