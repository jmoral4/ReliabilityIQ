@page "/run/{runId}/findings"
@model ReliabilityIQ.Web.Pages.Run.FindingsModel
@{
    ViewData["Title"] = "Findings";
}

@if (Model.Run is null)
{
    <div class="alert alert-warning" role="alert">Run not found.</div>
}
else
{
    <section class="mb-3">
        <h1 class="h3 mb-1">Findings</h1>
        <div class="small text-body-secondary">
            <span class="font-monospace">@Model.Run.RunId</span>
            <span class="mx-2">|</span>
            <span>@Model.Run.TotalFindings total</span>
            <span class="mx-2">|</span>
            <span class="font-monospace">@Model.Run.RepoRoot</span>
        </div>
    </section>

    <div class="row g-3">
        <aside class="col-12 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-body-secondary">Filters</h2>

                    <div class="mb-3">
                        <label for="severityFilter" class="form-label">Severity</label>
                        <select id="severityFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="Error">Error</option>
                            <option value="Warning">Warning</option>
                            <option value="Info">Info</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="ruleFilter" class="form-label">Rule</label>
                        <select id="ruleFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                            @foreach (var rule in Model.RuleSummary)
                            {
                                <option value="@rule.RuleId">@rule.RuleId (@rule.FindingCount)</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label">File Category</label>
                        <select id="categoryFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                            @foreach (var category in Model.FileCategories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="languageFilter" class="form-label">Language</label>
                        <select id="languageFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                            @foreach (var language in Model.Languages)
                            {
                                <option value="@language">@language</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="confidenceFilter" class="form-label">Confidence</label>
                        <select id="confidenceFilter" class="form-select form-select-sm">
                            <option value="">All</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="pathPrefixFilter" class="form-label">Path Prefix</label>
                        <input id="pathPrefixFilter" class="form-control form-control-sm font-monospace" type="text" placeholder="src/" />
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showSuppressedToggle" />
                        <label class="form-check-label" for="showSuppressedToggle">
                            Show suppressed findings
                        </label>
                    </div>

                    <button id="applyFilters" type="button" class="btn btn-sm btn-primary w-100">Apply Filters</button>
                </div>
            </div>
        </aside>

        <div class="col-12 col-lg-9">
            <div class="table-responsive">
                <table id="findingsTable" class="table table-striped table-hover align-middle w-100">
                    <thead>
                    <tr>
                        <th></th>
                        <th>Signal</th>
                        <th>Severity</th>
                        <th>Rule ID</th>
                        <th>File Path</th>
                        <th>Line</th>
                        <th>Language</th>
                        <th>Category</th>
                        <th>Message</th>
                        <th>Confidence</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
}

@section Scripts
{
    <script>
        function escapeHtml(value) {
            if (!value) return "";
            return String(value)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function severityBadge(severity) {
            if (severity === "Error") return '<span class="badge text-bg-danger">Error</span>';
            if (severity === "Warning") return '<span class="badge text-bg-warning text-dark">Warning</span>';
            return '<span class="badge text-bg-info text-dark">Info</span>';
        }

        function confidenceBadge(confidence) {
            if (confidence === "High") return '<span class="badge text-bg-success">High</span>';
            if (confidence === "Medium") return '<span class="badge text-bg-primary">Medium</span>';
            return '<span class="badge text-bg-secondary">Low</span>';
        }

        function signalBadge(row) {
            return row.astConfirmed
                ? '<span class="badge text-bg-success-subtle text-success-emphasis">AST</span>'
                : '<span class="badge text-bg-secondary">Regex</span>';
        }

        function parseMetadata(metadata) {
            if (!metadata) {
                return {};
            }

            try {
                return JSON.parse(metadata);
            } catch {
                return {};
            }
        }

        const runId = "@Model.RunId";
        const table = new DataTable("#findingsTable", {
            serverSide: true,
            processing: true,
            pageLength: 25,
            order: [[2, "asc"]],
            ajax: {
                url: `/api/run/${encodeURIComponent(runId)}/findings`,
                data: function (d) {
                    d.severity = document.getElementById("severityFilter").value;
                    d.rule = document.getElementById("ruleFilter").value;
                    d.confidence = document.getElementById("confidenceFilter").value;
                    d.fileCategory = document.getElementById("categoryFilter").value;
                    d.language = document.getElementById("languageFilter").value;
                    d.pathPrefix = document.getElementById("pathPrefixFilter").value;
                    d.includeSuppressed = document.getElementById("showSuppressedToggle").checked;
                }
            },
            createdRow: function (row, data) {
                if (data.isSuppressed) {
                    row.classList.add("suppressed-row");
                }
            },
            columns: [
                {
                    data: null,
                    name: "expand",
                    orderable: false,
                    className: "details-toggle",
                    defaultContent: '<button class="btn btn-sm btn-outline-secondary" type="button">+</button>'
                },
                {
                    data: null,
                    name: "signal",
                    orderable: false,
                    render: function (_, __, row) { return signalBadge(row); }
                },
                {
                    data: "severity",
                    name: "severity",
                    render: function (data) { return severityBadge(data); }
                },
                { data: "ruleId", name: "ruleId", className: "font-monospace small" },
                {
                    data: null,
                    name: "filePath",
                    className: "font-monospace small",
                    render: function (_, __, row) {
                        const encodedRun = encodeURIComponent(runId);
                        const encodedFileId = encodeURIComponent(row.fileId);
                        return `<a href="/run/${encodedRun}/file/${encodedFileId}" class="link-dark">${escapeHtml(row.filePath)}</a>`;
                    }
                },
                { data: "line", name: "line" },
                { data: "language", name: "language", defaultContent: "-", orderable: false },
                { data: "fileCategory", name: "fileCategory", defaultContent: "-", orderable: false },
                { data: "message", name: "message", orderable: false, render: function (data) { return escapeHtml(data); } },
                { data: "confidence", name: "confidence", render: function (data) { return confidenceBadge(data); } }
            ]
        });

        document.getElementById("applyFilters").addEventListener("click", function () {
            table.ajax.reload();
        });

        document.getElementById("findingsTable").addEventListener("click", function (event) {
            const button = event.target.closest("button");
            if (!button) {
                return;
            }

            const rowElement = button.closest("tr");
            const row = table.row(rowElement);
            if (row.child.isShown()) {
                row.child.hide();
                button.textContent = "+";
                return;
            }

            const data = row.data();
            const metadata = parseMetadata(data.metadata);
            const callsite = metadata.callsite || metadata.context || "n/a";
            const engine = metadata.engine || (data.astConfirmed ? "ast" : "regex");
            const snippet = data.snippet
                ? `<pre><code class="language-${escapeHtml((data.language || "plaintext").toLowerCase())}">${escapeHtml(data.snippet)}</code></pre>`
                : "<p class=\"mb-2 small text-body-secondary\">No snippet captured.</p>";
            const suppression = data.isSuppressed
                ? `<div class="alert alert-secondary py-2 px-3 small mb-2">Suppressed${data.suppressionReason ? `: ${escapeHtml(data.suppressionReason)}` : ""}</div>`
                : "";
            const remediation = data.ruleDescription
                ? `<div class="mt-2"><button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#remediation-${data.findingId}" aria-expanded="false">Remediation</button><div class="collapse mt-2" id="remediation-${data.findingId}"><div class="card card-body small">${escapeHtml(data.ruleDescription)}</div></div></div>`
                : "";
            const details = `
                <div class="p-2">
                    ${suppression}
                    <div class="row g-2 mb-2 small">
                        <div class="col-md-4"><span class="text-body-secondary">Engine:</span> ${escapeHtml(engine)}</div>
                        <div class="col-md-8"><span class="text-body-secondary">Callsite Context:</span> <span class="font-monospace">${escapeHtml(callsite)}</span></div>
                    </div>
                    <div class="small text-body-secondary mb-1">Full Message</div>
                    <div class="mb-2">${escapeHtml(data.message)}</div>
                    <div class="small text-body-secondary mb-1">Snippet</div>
                    ${snippet}
                    ${remediation}
                </div>`;

            row.child(details).show();
            button.textContent = "-";
            document.querySelectorAll("pre code").forEach(function (el) {
                hljs.highlightElement(el);
            });
        });
    </script>
}
