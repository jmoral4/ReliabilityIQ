@page "/rules"
@model ReliabilityIQ.Web.Pages.RulesModel
@{
    ViewData["Title"] = "Rules";
}

<section class="mb-3">
    <h1 class="h3 mb-1">Rules</h1>
    <div class="small text-body-secondary">Browse all known rules and inspect findings across runs.</div>
</section>

<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-4 col-lg-3">
        <label class="form-label" for="category">Category</label>
        <select class="form-select form-select-sm" id="category" name="category">
            <option value="">All</option>
            <option value="portability" selected="@(Model.Category == "portability")">portability</option>
            <option value="magic-strings" selected="@(Model.Category == "magic-strings")">magic-strings</option>
            <option value="churn" selected="@(Model.Category == "churn")">churn</option>
            <option value="deploy" selected="@(Model.Category == "deploy")">deploy</option>
            <option value="custom" selected="@(Model.Category == "custom")">custom</option>
        </select>
    </div>
    <div class="col-12 col-md-5 col-lg-4">
        <label class="form-label" for="ruleId">Rule ID</label>
        <input class="form-control form-control-sm font-monospace" id="ruleId" name="ruleId" value="@Model.RuleId" placeholder="portability.hardcoded.dns" />
    </div>
    <div class="col-12 col-md-3 col-lg-2">
        <button class="btn btn-sm btn-primary w-100" type="submit">Apply</button>
    </div>
</form>

<div class="table-responsive mb-4">
    <table class="table table-striped table-hover align-middle">
        <thead>
        <tr>
            <th>Rule</th>
            <th>Title</th>
            <th>Category</th>
            <th>Default Severity</th>
            <th>Effective State</th>
            <th>Total Findings</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var rule in Model.Rules)
        {
            var stateBadge = rule.EffectiveState switch
            {
                "Enabled" => "text-bg-success",
                "Overridden" => "text-bg-warning text-dark",
                "No Findings" => "text-bg-secondary",
                _ => "text-bg-secondary"
            };

            <tr>
                <td class="font-monospace small">
                    <a asp-page="/Rules" asp-route-category="@Model.Category" asp-route-ruleId="@rule.RuleId">@rule.RuleId</a>
                </td>
                <td>@rule.Title</td>
                <td><span class="badge text-bg-light">@rule.Category</span></td>
                <td>@rule.DefaultSeverity</td>
                <td><span class="badge @stateBadge">@rule.EffectiveState</span></td>
                <td>@rule.TotalFindings</td>
            </tr>
            if (!string.IsNullOrWhiteSpace(rule.Description))
            {
                <tr>
                    <td></td>
                    <td colspan="5" class="small text-body-secondary">@rule.Description</td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

@if (!string.IsNullOrWhiteSpace(Model.RuleId))
{
    <section>
        <h2 class="h5 mb-2">Findings Across Runs: <span class="font-monospace">@Model.RuleId</span></h2>
        @if (Model.RuleFindings.Count == 0)
        {
            <div class="alert alert-light border">No findings found for this rule.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Run</th>
                        <th>Started (UTC)</th>
                        <th>File</th>
                        <th>Line</th>
                        <th>Severity</th>
                        <th>Message</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var finding in Model.RuleFindings)
                    {
                        <tr>
                            <td class="font-monospace small"><a asp-page="/Run/Findings" asp-route-runId="@finding.RunId">@finding.RunId</a></td>
                            <td>@finding.StartedAt.UtcDateTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td class="font-monospace small">@finding.FilePath</td>
                            <td>@finding.Line</td>
                            <td>@finding.Severity</td>
                            <td>@finding.Message</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </section>
}
